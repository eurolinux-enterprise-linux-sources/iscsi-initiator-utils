From 0fa43f292d1e2a55ebd874e6a5b4444b886ee9fe Mon Sep 17 00:00:00 2001
From: Hannes Reinecke <hare@suse.de>
Date: Fri, 15 Jan 2016 14:56:28 -0800
Subject: [PATCH] iscsiuio: fixup race condition

valgrind detected a race condition in the nic receive loop.

Signed-off-by: Hannes Reinecke <hare@suse.de>
Acked-by: Lee Duncan <lduncan@suse.com>
---
 iscsiuio/src/unix/nic.c | 4 ++--
 1 file changed, 2 insertions(+), 2 deletions(-)

diff --git a/iscsiuio/src/unix/nic.c b/iscsiuio/src/unix/nic.c
index 2fe00f1..74b7c5e 100644
--- a/iscsiuio/src/unix/nic.c
+++ b/iscsiuio/src/unix/nic.c
@@ -1491,13 +1491,13 @@ void *nic_loop(void *arg)
 
 		/*  Signal that the device enable is done */
 		pthread_cond_broadcast(&nic->enable_done_cond);
-		pthread_mutex_unlock(&nic->nic_mutex);
 
 		LOG_INFO(PFX "%s: entering main nic loop", nic->log_name);
 
 		while ((nic->state == NIC_RUNNING) &&
 		       (event_loop_stop == 0) &&
 		       !(nic->flags & NIC_GOING_DOWN)) {
+			pthread_mutex_unlock(&nic->nic_mutex);
 			/*  Check the periodic and ARP timer */
 			check_timers(nic, &periodic_timer, &arp_timer);
 			rc = nic_process_intr(nic, 0);
@@ -1508,6 +1508,7 @@ void *nic_loop(void *arg)
 						     &periodic_timer,
 						     &arp_timer, NULL);
 			}
+			pthread_mutex_lock(&nic->nic_mutex);
 		}
 
 		LOG_INFO(PFX "%s: exited main processing loop", nic->log_name);
@@ -1515,7 +1516,6 @@ void *nic_loop(void *arg)
 dev_close_free:
 		free_free_queue(nic);
 dev_close:
-		pthread_mutex_lock(&nic->nic_mutex);
 
 		if (nic->flags & NIC_GOING_DOWN) {
 			nic_close(nic, 1, FREE_NO_STRINGS);
-- 
2.7.4

